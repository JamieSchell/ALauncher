# ADR-003: Стратегия обновлений лаунчера

## Статус
Принято

## Контекст
Лаунчер должен поддерживать автоматическое обновление до новых версий. Необходимо выбрать стратегию обновления, которая:
- Минимизирует неудобства для пользователя
- Обеспечивает безопасность
- Работает на всех платформах (Windows, Linux, macOS)
- Поддерживает откат при проблемах

## Рассмотренные варианты

### 1. Полная замена установщика (текущая реализация)
**Описание:** Пользователь скачивает новый установщик и запускает его для обновления.

**Плюсы:**
- ✅ Простая реализация
- ✅ Работает на всех платформах
- ✅ Полный контроль над процессом установки
- ✅ Можно проверить целостность через хеш

**Минусы:**
- ❌ Требует ручного действия от пользователя
- ❌ Большой размер загрузки

### 2. Инкрементальные обновления (delta updates)
**Описание:** Загрузка только измененных файлов.

**Плюсы:**
- ✅ Меньший размер загрузки
- ✅ Быстрее обновление

**Минусы:**
- ❌ Сложная реализация
- ❌ Риск ошибок при применении патчей
- ❌ Требует версионирования каждого файла

### 3. Автоматическое обновление через встроенный механизм
**Описание:** Лаунчер автоматически скачивает и устанавливает обновления.

**Плюсы:**
- ✅ Удобство для пользователя
- ✅ Меньше пропущенных обновлений

**Минусы:**
- ❌ Требует прав администратора на некоторых системах
- ❌ Риск установки сломанной версии
- ❌ Сложнее откат

### 4. Обновление через пакетный менеджер
**Описание:** Использование системных пакетных менеджеров (apt, yum, brew, chocolatey).

**Плюсы:**
- ✅ Интеграция с системой
- ✅ Автоматические обновления через систему

**Минусы:**
- ❌ Требует публикации в репозиториях
- ❌ Разные процессы для разных платформ
- ❌ Медленнее процесс обновления

## Решение
Выбрана стратегия **полной замены установщика с опциональным автоматическим обновлением**:

1. **Основной механизм**: Полная замена через установщик
   - Пользователь получает уведомление о новой версии
   - Может скачать и установить вручную
   - Проверка целостности через SHA-256 хеш

2. **Опциональное автоматическое обновление**:
   - Пользователь может включить автоматическое обновление
   - Лаунчер скачивает установщик в фоне
   - Запрашивает разрешение на установку
   - Сохраняет предыдущую версию для отката

3. **Обязательные обновления**:
   - Критические обновления безопасности могут быть помечены как обязательные
   - Лаунчер блокирует запуск до обновления

## Реализация

### Компоненты системы

1. **Backend API** (`/api/launcher/check-update`):
   - Проверка наличия новой версии
   - Возврат информации о версии, URL загрузки, хеше, размере

2. **Frontend проверка**:
   - Проверка при запуске лаунчера
   - Периодическая проверка в фоне
   - Уведомление пользователя

3. **Процесс обновления**:
   - Скачивание установщика с прогресс-баром
   - Проверка хеша скачанного файла
   - Запуск установщика
   - Сохранение старой версии для отката

4. **База данных**:
   - Таблица `launcher_versions` с информацией о версиях
   - Поля: version, downloadUrl, fileHash, fileSize, isRequired, releaseNotes

## Последствия

### Положительные
- ✅ Гибкость: пользователь контролирует процесс
- ✅ Безопасность: проверка целостности через хеш
- ✅ Надежность: полная замена снижает риск ошибок
- ✅ Кроссплатформенность: работает везде одинаково

### Отрицательные
- ❌ Требует действия от пользователя (митигируется автоматическим режимом)
- ❌ Большой размер загрузки (приемлемо для десктопного приложения)

## Митигация рисков
- Проверка хеша перед установкой
- Сохранение предыдущей версии для отката
- Постепенное развертывание (сначала опциональное, затем обязательное)
- Мониторинг ошибок после обновления

## Будущие улучшения
- Инкрементальные обновления для больших версий
- Фоновая загрузка обновлений
- Автоматическая установка с подтверждением
- A/B тестирование новых версий

