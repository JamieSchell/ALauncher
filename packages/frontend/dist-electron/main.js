"use strict";const c=require("electron"),i=require("path"),h=require("fs"),v=require("fs/promises"),re=require("crypto"),k=require("child_process"),Q=require("https"),V=require("http"),te=require("os");let e=null,b=null;const S=new Map,H=process.env.NODE_ENV==="development";H&&(process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true");async function oe(t,s){try{const r=JSON.stringify({errorType:"ELECTRON_ERROR",errorMessage:t.message||String(t),stackTrace:t.stack||null,component:(s==null?void 0:s.component)||"ElectronMain",action:(s==null?void 0:s.action)||"unhandledError",os:process.platform,osVersion:te.release(),launcherVersion:c.app.getVersion()}),o={hostname:"localhost",port:7240,path:"/api/crashes/launcher-errors",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(r)},timeout:2e3},n=V.request(o,()=>{});n.on("error",()=>{}),n.write(r),n.end()}catch(r){console.error("[ErrorLogger] Failed to log error to backend:",r)}}process.on("uncaughtException",t=>{console.error("[Electron] Uncaught Exception:",t),oe(t,{component:"ElectronMain",action:"uncaughtException"})});process.on("unhandledRejection",(t,s)=>{console.error("[Electron] Unhandled Rejection:",t);const r=t instanceof Error?t:new Error(String(t));oe(r,{component:"ElectronMain",action:"unhandledRejection"})});function J(){console.log(`Stopping ${S.size} active downloads...`),S.forEach((t,s)=>{try{t.request.destroy(),t.writer.destroy(),h.existsSync(t.destPath)&&h.unlinkSync(t.destPath)}catch(r){console.error(`Error stopping download ${s}:`,r)}}),S.clear()}function ce(){if(!b)try{const t=Z(),s=[i.join(t,"assets","icon.png"),i.join(t,"icon.png"),i.join(process.cwd(),"assets","icon.png"),i.join(process.cwd(),"icon.png")];let r=null;for(const n of s)if(h.existsSync(n)){r=n;break}if(r)b=new c.Tray(r);else{const l=Buffer.alloc(1024);for(let a=0;a<l.length;a+=4)l[a]=20,l[a+1]=20,l[a+2]=20,l[a+3]=255;const f=(a,p)=>{if(a>=0&&a<16&&p>=0&&p<16){const m=(p*16+a)*4;l[m]=255,l[m+1]=255,l[m+2]=255}};for(let a=4;a<12;a++)f(3,a),f(12,a),a<8&&(f(3+(a-4),a),f(12-(a-4),a));const u=c.nativeImage.createFromBuffer(l,{width:16,height:16});b=new c.Tray(u)}const o=c.Menu.buildFromTemplate([{label:"Show Launcher",click:()=>{e?(e.show(),e.focus()):U()}},{label:"Quit",click:()=>{console.log("[Tray] Quit requested - closing all windows and exiting..."),J(),e&&(e.removeAllListeners("close"),e.destroy(),e=null),b&&(b.destroy(),b=null),setTimeout(()=>{c.app.exit(0)},100)}}]);b.setToolTip("Modern Launcher"),b.setContextMenu(o),b.on("click",()=>{e?e.isVisible()?e.hide():(e.show(),e.focus()):U()})}catch(t){console.error("Failed to create tray:",t)}}function Z(){return H?process.cwd():c.app.getAppPath()}function U(){const t=Z();let s;if(H)s=i.join(t,"dist-electron","preload.js");else{const r=[i.join(__dirname,"preload.js"),i.join(t,"preload.js"),i.join(process.resourcesPath,"app","preload.js"),i.join(process.resourcesPath,"app.asar.unpacked","preload.js")];s=r.find(o=>h.existsSync(o))||r[0],console.log("Using preload path:",s)}if(e=new c.BrowserWindow({width:1200,height:750,minWidth:900,minHeight:600,frame:!1,transparent:!1,backgroundColor:"#0a0a0a",webPreferences:{preload:s,contextIsolation:!0,nodeIntegration:!1,sandbox:!1,webSecurity:!0},show:!1}),e.once("ready-to-show",()=>{e==null||e.show()}),H)e.loadURL("http://localhost:5173"),e.webContents.openDevTools();else{const r=i.join(t,"dist","index.html");if(console.log("Production mode - Loading index.html from:",r),console.log("app.getAppPath():",c.app.getAppPath()),console.log("__dirname:",__dirname),console.log("process.resourcesPath:",process.resourcesPath),h.existsSync(r))e.loadFile(r,{hash:""}).catch(o=>{console.error("Failed to load index.html:",o),console.error("Error details:",{code:o.code,message:o.message,stack:o.stack});const l=`file:///${i.resolve(r).replace(/\\/g,"/")}`;console.log("Trying alternative URL:",l),e.loadURL(l).catch(f=>{console.error("Failed to load via URL:",f),e==null||e.webContents.openDevTools()})});else{console.error("index.html not found at:",r);const o=[i.join(__dirname,"..","dist","index.html"),i.join(process.resourcesPath,"app","dist","index.html")];for(const n of o)if(h.existsSync(n)){console.log("Found index.html at alternative path:",n),e.loadFile(n);break}}e.webContents.openDevTools()}e.webContents.on("did-fail-load",(r,o,n,l)=>{console.error("❌ Page failed to load:",{errorCode:o,errorDescription:n,validatedURL:l}),console.error("Error code:",o),console.error("Error description:",n),console.error("Validated URL:",l),e==null||e.webContents.openDevTools(),e==null||e.webContents.send("app:error",`Failed to load page: ${n}`)}),e.webContents.on("did-finish-load",()=>{console.log("✅ Page loaded successfully");const r=e==null?void 0:e.webContents.getURL();console.log("Current URL:",r)}),e.webContents.on("dom-ready",()=>{console.log("✅ DOM is ready")}),e.webContents.on("console-message",(r,o,n,l,f)=>{console.log(`[Renderer ${o}]:`,n),o===3&&console.error("Renderer error:",{message:n,line:l,sourceId:f})}),e.on("closed",()=>{e=null}),e.on("close",r=>{b&&process.platform!=="darwin"?(r.preventDefault(),e==null||e.hide()):(J(),e&&(e.destroy(),e=null))}),e.on("minimize",()=>{})}c.app.on("session-created",t=>{t.webRequest.onHeadersReceived((s,r)=>{r({responseHeaders:{...s.responseHeaders,"Content-Security-Policy":["default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: http://localhost:* ws://localhost:* wss://localhost:*; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:*; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: http: https:; font-src 'self' data:; connect-src 'self' http://localhost:* ws://localhost:* wss://localhost:*;"]}})})});const le=c.app.requestSingleInstanceLock();le?(c.app.on("second-instance",()=>{e?(e.isMinimized()&&e.restore(),e.focus()):U()}),c.app.whenReady().then(()=>{U(),ce(),c.app.on("activate",()=>{c.BrowserWindow.getAllWindows().length===0?U():e&&(e.show(),e.focus())})}),c.app.on("window-all-closed",()=>{b||process.platform!=="darwin"&&(J(),c.app.quit())})):(console.log("Another instance is already running. Exiting..."),c.app.quit(),process.exit(0));c.app.on("before-quit",()=>{J()});c.ipcMain.on("window:minimize",()=>{e==null||e.minimize()});c.ipcMain.on("window:maximize",()=>{e!=null&&e.isMaximized()?e.unmaximize():e==null||e.maximize()});c.ipcMain.on("window:close",()=>{J(),e==null||e.close()});c.ipcMain.on("window:minimizeToTray",()=>{e&&e.hide()});function ne(t){const s=[];try{if(!h.existsSync(t))return s;const r=h.readdirSync(t,{withFileTypes:!0});for(const o of r){const n=i.join(t,o.name);o.isDirectory()?s.push(...ne(n)):o.isFile()&&o.name.endsWith(".jar")&&s.push(n)}}catch(r){console.error(`Error reading directory ${t}:`,r)}return s}function ee(t){const s=[],r=new Set;function o(n){if(!(r.has(n)||!h.existsSync(n))){r.add(n);try{const l=h.readdirSync(n,{withFileTypes:!0});for(const f of l){const u=i.join(n,f.name);if(f.isDirectory()){if(f.name==="natives"){s.push(u);continue}o(u)}else if(f.isFile()){const a=i.extname(f.name).toLowerCase();(a===".dll"||a===".so"||a===".dylib")&&(s.includes(n)||s.push(n))}}}catch{}}}return o(t),Array.from(new Set(s))}function ae(){const t=i.resolve(process.cwd(),"updates");if(h.existsSync(t))return console.log("Found updates in process.cwd():",t),t;const s=i.resolve(process.cwd(),"packages","backend","updates");if(h.existsSync(s))return console.log("Found updates in packages/backend/updates:",s),s;let o=Z();const n=10;let l=0;for(;l<n&&o!==i.dirname(o);){const u=i.join(o,"packages"),a=i.join(o,"updates");if(h.existsSync(u)&&h.existsSync(a))return console.log("Found updates in project root:",a),i.resolve(a);o=i.dirname(o),l++}try{const u=c.app.getAppPath();let a=i.dirname(u);for(let p=0;p<5;p++){const m=i.join(a,"updates");if(h.existsSync(m))return console.log("Found updates relative to app path:",m),i.resolve(m);a=i.dirname(a)}}catch(u){console.warn("Could not get app path:",u)}const f=i.resolve(process.cwd(),"updates");return console.log("Using default updates path:",f),f}function se(t){const s=t.toLowerCase();return s.includes("connection refused")||s.includes("connection.*refused")?"CONNECTION_REFUSED":s.includes("timeout")||s.includes("timed out")?"CONNECTION_TIMEOUT":s.includes("authentication")||s.includes("auth")?"AUTHENTICATION_FAILED":s.includes("server full")||s.includes("server.*full")?"SERVER_FULL":s.includes("version")&&s.includes("mismatch")?"VERSION_MISMATCH":s.includes("network")||s.includes("network.*error")?"NETWORK_ERROR":"UNKNOWN"}function ue(){const t=[],s=process.platform==="win32",r=process.platform==="darwin",o=process.platform==="linux",n=process.env.JAVA_HOME;if(n){const l=s?i.join(n,"bin","java.exe"):i.join(n,"bin","java");h.existsSync(l)&&t.push(l)}try{k.execSync("java -version",{timeout:2e3,stdio:"pipe"}),t.push("java")}catch{}if(s){const l=process.env.ProgramFiles||"C:\\Program Files",f=process.env["ProgramFiles(x86)"]||"C:\\Program Files (x86)",u=[i.join(l,"Java"),i.join(f,"Java"),i.join(process.env.LOCALAPPDATA||"","Programs","Java"),"C:\\Program Files\\Eclipse Adoptium","C:\\Program Files\\Eclipse Foundation","C:\\Program Files\\Microsoft","C:\\Program Files\\OpenJDK"];for(const a of u)if(h.existsSync(a))try{const p=h.readdirSync(a,{withFileTypes:!0});for(const m of p)if(m.isDirectory()){const y=i.join(a,m.name,"bin","java.exe");h.existsSync(y)&&t.push(y)}}catch{}try{const p=k.execSync('reg query "HKLM\\SOFTWARE\\JavaSoft\\Java Runtime Environment" /s /v JavaHome 2>nul',{encoding:"utf-8",timeout:3e3,stdio:"pipe"}).match(/JavaHome\s+REG_SZ\s+(.+)/g);if(p)for(const m of p){const y=m.replace(/JavaHome\s+REG_SZ\s+/,"").trim(),x=i.join(y,"bin","java.exe");h.existsSync(x)&&!t.includes(x)&&t.push(x)}}catch{}}if(r){const l=["/Library/Java/JavaVirtualMachines","/System/Library/Java/JavaVirtualMachines","/usr/libexec/java_home"];for(const f of l)if(h.existsSync(f))try{const u=h.readdirSync(f,{withFileTypes:!0});for(const a of u)if(a.isDirectory()){const p=i.join(f,a.name,"Contents","Home","bin","java");h.existsSync(p)&&t.push(p)}}catch{}try{const u=k.execSync("/usr/libexec/java_home -V",{timeout:2e3,stdio:"pipe",encoding:"utf-8"}).match(/\/Library\/Java\/JavaVirtualMachines\/[^\s]+/g);if(u)for(const a of u){const p=i.join(a,"Contents","Home","bin","java");h.existsSync(p)&&!t.includes(p)&&t.push(p)}}catch{}}if(o){const l=["/usr/lib/jvm","/usr/java","/opt/java","/usr/local/java"];for(const f of l)if(h.existsSync(f))try{const u=h.readdirSync(f,{withFileTypes:!0});for(const a of u)if(a.isDirectory()){const p=i.join(f,a.name,"bin","java");h.existsSync(p)&&!t.includes(p)&&t.push(p)}}catch{}}return Array.from(new Set(t))}function _(t){try{const s=k.execSync(`"${t}" -version 2>&1`,{timeout:5e3,encoding:"utf-8",stdio:"pipe"}),r=s.match(/version\s+"?(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:_(\d+))?"?/);if(r){const o=parseInt(r[1],10),n=r[2]?parseInt(r[2],10):0,l=r[3]?parseInt(r[3],10):0,f=r[4]?parseInt(r[4],10):0,u=o===1&&n>0?n:o;return{version:`${u}.${l||0}`,major:u,full:s.split(`
`)[0]||s}}return null}catch(s){return console.error(`Failed to get Java version from ${t}:`,s),null}}function ie(t,s){const r=_(t);if(!r)return{valid:!1,requiredVersion:s,error:`Failed to determine Java version from ${t}`};const o=parseInt(s,10),n=r.major>=o;return{valid:n,currentVersion:r.version,requiredVersion:s,error:n?void 0:`Java ${r.major} is installed, but Java ${o} or higher is required`}}c.ipcMain.handle("launcher:launch",async(t,s)=>{var j,z;const{javaPath:r,jvmArgs:o,mainClass:n,classPath:l,gameArgs:f,workingDir:u,version:a,jvmVersion:p,profileId:m,serverAddress:y,serverPort:x,userId:w,username:D}=s;try{const E=ae();console.log("Updates directory:",E);const C=i.isAbsolute(u)?u:i.resolve(process.cwd(),u),F=[];for(const d of l)if(d==="client.jar"){let g=i.join(E,a,"client.jar");if(h.existsSync(g)||(g=i.join(C,a,"client.jar")),!h.existsSync(g))return{success:!1,error:`Client JAR not found. Searched in:
- ${i.join(E,a,"client.jar")}
- ${i.join(C,a,"client.jar")}

Please download Minecraft files first using: npm run download-minecraft ${a}`};F.push(g)}else if(d==="libraries"){let g=i.join(E,a,"libraries");h.existsSync(g)||(g=i.join(C,a,"libraries"));const P=ne(g);P.length===0&&console.warn(`No JAR files found in ${g}`),F.push(...P);const T=ee(g);T.length>0&&console.log(`Found ${T.length} native library directories`)}else{let g=i.isAbsolute(d)?d:i.join(E,a,d);h.existsSync(g)||(g=i.join(C,a,d)),h.existsSync(g)?F.push(g):console.warn(`ClassPath entry not found: ${g}`)}if(F.length===0)return{success:!1,error:"No valid classpath entries found. Please ensure Minecraft files are downloaded."};h.existsSync(C)||(console.log(`Creating working directory: ${C}`),h.mkdirSync(C,{recursive:!0}));const B=i.join(E,a,"libraries"),R=h.existsSync(B)?ee(B):[];console.log(`Searching for native libraries in: ${B}`),console.log(`Found ${R.length} native library directories:`),R.forEach(d=>console.log(`  - ${d}`));const A=[...o];if(R.length>0){const d=R.join(i.delimiter);A.push(`-Djava.library.path=${d}`),console.log(`Added native library path: ${d}`)}else console.warn("⚠️  No native libraries found! This may cause UnsatisfiedLinkError."),console.warn(`   Please re-download Minecraft files: npm run download-minecraft ${a}`);if(A.push("-cp",F.join(i.delimiter),n,...f),console.log("Launching Minecraft with:",{javaPath:r,workingDir:C,classPathCount:F.length,mainClass:n,jvmArgsCount:o.length,gameArgsCount:f.length}),console.log("Full command:",`${r} ${A.join(" ")}`),r!=="java"&&!h.existsSync(r))return{success:!1,error:`Java executable not found: ${r}. Please check the Java path in settings.`};let $=null;try{const d=p||"8";if($=ie(r,d),!$.valid)return{success:!1,error:$.error||`Java version check failed. Required: Java ${d}+, found: ${$.currentVersion||"unknown"}`};console.log(`Java version check passed: ${$.currentVersion} (required: ${d}+)`)}catch(d){return{success:!1,error:`Failed to verify Java: ${d.message}. Please install Java or specify the full path to Java in settings.`}}let G=null,I=!1,N=null;const M=k.spawn(r,A,{cwd:C,stdio:"pipe",shell:!1});M.on("error",d=>{G=d,console.error("Process spawn error:",d),e==null||e.webContents.send("game:error",`Process error: ${d.message}`)});let K="",X="";const L=[],Y=100,W=[/connection.*refused/i,/connection.*timeout/i,/connection.*timed.*out/i,/authentication.*failed/i,/server.*full/i,/version.*mismatch/i,/network.*error/i,/can't.*connect/i,/unable.*to.*connect/i,/failed.*to.*connect/i];return(j=M.stderr)==null||j.on("data",d=>{const g=d.toString();K+=g,console.error("Game stderr:",g),e==null||e.webContents.send("game:error",g);for(const P of W)if(P.test(g)){e==null||e.webContents.send("game:connection-issue",{message:g,type:se(g)});break}}),(z=M.stdout)==null||z.on("data",d=>{const g=d.toString();console.log("Game stdout:",g),e==null||e.webContents.send("game:log",g);const P=g.split(`
`).filter(T=>T.trim());L.push(...P),L.length>Y&&L.splice(0,L.length-Y),X=L.join(`
`);for(const T of W)if(T.test(g)){e==null||e.webContents.send("game:connection-issue",{message:g,type:se(g)});break}}),M.on("exit",(d,g)=>{if(I=!0,N=d,console.log(`Game process exited with code ${d}, signal ${g}`),e==null||e.webContents.send("game:exit",d??0),d!==0&&d!==null){const P=K||`Game exited with code ${d}`;console.error("Game failed:",P),e==null||e.webContents.send("game:error",P),e==null||e.webContents.send("game:crash",{exitCode:d,errorMessage:P.substring(0,5e3),stderrOutput:K.substring(0,1e4),stdoutOutput:X.substring(0,1e4),profileId:m,profileVersion:a,serverAddress:y,serverPort:x,javaVersion:$==null?void 0:$.currentVersion,javaPath:r,os:process.platform,osVersion:te.release(),userId:w,username:D})}}),M.on("close",(d,g)=>{I||(console.log(`Game process closed with code ${d}, signal ${g}`),I=!0,N=d,e==null||e.webContents.send("game:exit",d??0))}),await new Promise(d=>setTimeout(d,500)),G?{success:!1,error:`Failed to start Java process: ${G.message}`}:I&&N!==0?{success:!1,error:`Game process exited immediately with code ${N}. Check the error messages above.`}:M.pid?(console.log(`Game process started successfully with PID: ${M.pid}`),{success:!0,pid:M.pid}):{success:!1,error:"Failed to start game process (no PID). Check Java installation and arguments."}}catch(E){return{success:!1,error:E.message}}});c.ipcMain.handle("file:ensureDir",async(t,s)=>{try{return await v.mkdir(s,{recursive:!0}),{success:!0}}catch(r){return{success:!1,error:r.message}}});c.ipcMain.handle("file:writeFile",async(t,s,r)=>{try{const o=i.dirname(s);return await v.mkdir(o,{recursive:!0}),await v.writeFile(s,Buffer.from(r)),{success:!0}}catch(o){return{success:!1,error:o.message}}});c.ipcMain.handle("file:deleteFile",async(t,s)=>{try{return await v.unlink(s),{success:!0}}catch(r){return{success:!1,error:r.message}}});c.ipcMain.handle("file:calculateHash",async(t,s,r)=>{try{const o=await v.readFile(s);return re.createHash(r).update(o).digest("hex")}catch(o){throw new Error(`Failed to calculate hash: ${o.message}`)}});c.ipcMain.handle("file:exists",async(t,s)=>{try{return await v.access(s),!0}catch{return!1}});c.ipcMain.on("file:download",async(t,s,r,o)=>{const n=`${s}-${r}`;try{const l=i.dirname(r);await v.mkdir(l,{recursive:!0});const f=s.startsWith("https:")?Q:V,u={};o&&(u.headers={Authorization:`Bearer ${o}`});const a=f.get(s,u,p=>{if(p.statusCode!==200){S.delete(n),t.reply("file:download:error",`HTTP ${p.statusCode}`);return}const m=parseInt(p.headers["content-length"]||"0",10),y=h.createWriteStream(r);let x=0;S.set(n,{request:a,writer:y,destPath:r}),p.on("data",w=>{x+=w.length;const D=m>0?x/m*100:0;t.reply("file:download:progress",D)}),p.on("end",()=>{S.delete(n),y.end(),t.reply("file:download:complete")}),p.on("error",w=>{S.delete(n),y.destroy(),h.unlink(r,()=>{}),t.reply("file:download:error",w.message)}),p.pipe(y),y.on("error",w=>{S.delete(n),p.destroy(),t.reply("file:download:error",w.message)}),y.on("finish",()=>{S.delete(n)})});a.on("error",p=>{S.delete(n),t.reply("file:download:error",p.message)})}catch(l){S.delete(n),t.reply("file:download:error",l.message)}});c.ipcMain.handle("app:version",()=>c.app.getVersion());c.ipcMain.handle("app:paths",()=>({userData:c.app.getPath("userData"),appData:c.app.getPath("appData"),temp:c.app.getPath("temp")}));c.ipcMain.handle("app:updatesDir",()=>ae());c.ipcMain.handle("java:findInstallations",async()=>{try{return{success:!0,installations:ue().map(r=>{const o=_(r);return{path:r,version:(o==null?void 0:o.version)||"unknown",major:(o==null?void 0:o.major)||0,full:(o==null?void 0:o.full)||""}})}}catch(t){return{success:!1,error:t.message,installations:[]}}});c.ipcMain.handle("java:checkVersion",async(t,s,r)=>{try{return{success:!0,...ie(s,r)}}catch(o){return{success:!1,valid:!1,error:o.message,requiredVersion:r}}});c.ipcMain.handle("java:getVersion",async(t,s)=>{try{const r=_(s);return r?{success:!0,...r}:{success:!1,error:"Failed to get Java version"}}catch(r){return{success:!1,error:r.message}}});c.ipcMain.handle("dialog:selectJavaFile",async()=>{try{const t=process.platform==="win32",s=await c.dialog.showOpenDialog(e,{title:"Select Java Executable",filters:[{name:"Java Executable",extensions:t?["exe"]:[]},{name:"All Files",extensions:["*"]}],properties:["openFile"]});if(s.canceled||s.filePaths.length===0)return{success:!1,canceled:!0};const r=s.filePaths[0],o=_(r);return o?{success:!0,path:r,version:o.version,major:o.major}:{success:!1,error:"Selected file is not a valid Java executable"}}catch(t){return{success:!1,error:t.message}}});c.ipcMain.handle("notification:show",async(t,s,r,o)=>{try{if(!c.Notification.isSupported())return console.warn("Desktop notifications are not supported on this system"),{success:!1,error:"Notifications not supported"};const n=new c.Notification({title:s,body:r,icon:o==null?void 0:o.icon,silent:!(o!=null&&o.sound)});return n.on("click",()=>{e&&(e.isMinimized()&&e.restore(),e.focus())}),n.show(),setTimeout(()=>{n.close()},5e3),{success:!0}}catch(n){return console.error("Error showing notification:",n),{success:!1,error:n.message}}});let q=0,O=null;c.ipcMain.handle("launcher:checkUpdate",async(t,s,r)=>{try{const o=`${r}/api/launcher/check-update?currentVersion=${encodeURIComponent(s)}`;return console.log(`[LauncherUpdate] Checking for updates: ${o}`),console.log(`[LauncherUpdate] Current version: ${s}`),new Promise(n=>{const f=(o.startsWith("https:")?Q:V).get(o,u=>{let a="";console.log(`[LauncherUpdate] Response status: ${u.statusCode}`),u.on("data",p=>{a+=p}),u.on("end",()=>{var p;try{console.log(`[LauncherUpdate] Response data: ${a.substring(0,200)}...`);const m=JSON.parse(a);m.success&&m.data?m.data.hasUpdate?(console.log(`[LauncherUpdate] Update found! Version: ${(p=m.data.latestVersion)==null?void 0:p.version}`),n({success:!0,hasUpdate:!0,updateInfo:m.data.latestVersion,isRequired:m.data.isRequired})):(console.log("[LauncherUpdate] No updates available"),n({success:!0,hasUpdate:!1})):(console.error("[LauncherUpdate] Invalid response:",m),n({success:!1,error:"Invalid response from server"}))}catch(m){console.error("[LauncherUpdate] Parse error:",m),n({success:!1,error:`Failed to parse response: ${m.message}`})}})});f.on("error",u=>{console.error("[LauncherUpdate] Network error:",u),n({success:!1,error:`Network error: ${u.message}`})}),f.setTimeout(1e4,()=>{console.error("[LauncherUpdate] Request timeout"),f.destroy(),n({success:!1,error:"Request timeout"})})})}catch(o){return console.error("[LauncherUpdate] Error:",o),{success:!1,error:o.message}}});c.ipcMain.on("launcher:downloadUpdate",async(t,s,r)=>{try{const o=s.downloadUrl;if(!o){t.reply("launcher:update:error","Download URL is not provided");return}const n=process.platform==="win32",l=c.app.getPath("temp"),f=n?`launcher-update-${s.version}.exe`:`launcher-update-${s.version}.${process.platform==="darwin"?"dmg":"AppImage"}`,u=i.join(l,f),a=`${o}-${Date.now()}`;O=a,q=0,await v.mkdir(i.dirname(u),{recursive:!0});const m=(o.startsWith("https:")?Q:V).get(o,y=>{if(y.statusCode!==200){t.reply("launcher:update:error",`HTTP ${y.statusCode}`);return}const x=parseInt(y.headers["content-length"]||"0",10),w=h.createWriteStream(u);let D=0;y.on("data",j=>{if(O!==a){y.destroy(),w.destroy();return}D+=j.length,q=x>0?D/x*100:0,t.reply("launcher:update:progress",q)}),y.on("end",async()=>{if(O!==a){try{await v.unlink(u)}catch{}return}if(w.end(),s.fileHash)try{const j=await v.readFile(u);if(re.createHash("sha256").update(j).digest("hex").toLowerCase()!==s.fileHash.toLowerCase()){await v.unlink(u),t.reply("launcher:update:error","File hash verification failed. File may be corrupted.");return}}catch(j){await v.unlink(u),t.reply("launcher:update:error",`Hash verification error: ${j.message}`);return}t.reply("launcher:update:complete",u)}),y.on("error",async j=>{w.destroy();try{await v.unlink(u)}catch{}t.reply("launcher:update:error",j.message)}),y.pipe(w),w.on("error",async j=>{y.destroy();try{await v.unlink(u)}catch{}t.reply("launcher:update:error",j.message)})});m.on("error",y=>{t.reply("launcher:update:error",y.message)}),m.setTimeout(3e5,()=>{m.destroy(),t.reply("launcher:update:error","Download timeout")})}catch(o){t.reply("launcher:update:error",o.message)}});c.ipcMain.on("launcher:cancelUpdate",()=>{O=null,q=0});c.ipcMain.handle("launcher:installUpdate",async(t,s)=>{try{if(!h.existsSync(s))return{success:!1,error:"Installer file not found"};const r=process.platform==="win32",o=process.platform==="darwin",n=process.execPath;return r?(k.exec(`"${s}" /S /D="${i.dirname(n)}"`,l=>{l?console.error("Error running installer:",l):setTimeout(()=>{c.app.quit()},1e3)}),{success:!0}):o?(k.exec(`open "${s}"`,l=>{l&&console.error("Error opening DMG:",l)}),{success:!0,message:"Please follow the installation instructions"}):(await v.chmod(s,493),k.exec(`"${s}"`,l=>{l?console.error("Error running installer:",l):setTimeout(()=>{c.app.quit()},1e3)}),{success:!0})}catch(r){return{success:!1,error:r.message}}});c.ipcMain.on("launcher:restart",()=>{c.app.relaunch(),c.app.exit(0)});
