// Prisma Schema for Modern Launcher

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   // bcrypt hashed
  uuid      String   @unique // Minecraft UUID

  // Profile data
  email     String?  @unique
  skinUrl   String?
  cloakUrl  String?

  // Role
  role      UserRole @default(USER)

  // Ban status
  banned    Boolean  @default(false)
  bannedAt  DateTime?
  banReason String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?

  // Relations
  sessions      Session[]
  notifications Notification[]

  @@index([email])
  @@index([banned])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// Session model (for JWT blacklist and tracking)
model Session {
  id           String    @id @default(uuid())
  userId       String
  accessToken  String    @unique @db.VarChar(500)
  refreshToken String?   @unique @db.VarChar(500)
  expiresAt    DateTime
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime  @default(now())
  ipAddress    String?
  userAgent    String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([accessToken])
  @@map("sessions")
}

// Client Profile model
model ClientProfile {
  id            String   @id @default(uuid())
  version       String
  assetIndex    String
  clientDirectory String @default("") // Имя папки для файлов клиента (например, "HiTech", "HiPower")
  
  // Display
  sortIndex     Int
  title         String
  description   String?  // Описание сервера
  tags          Json?    // Массив пометок: ["NEW", "TOP", "WIP", "HARD", etc.]
  economyConfig Json?    // Конфигурация таблицы топа экономики
  serverAddress String
  serverPort    Int      @default(25565)
  jvmVersion    String?
  
  // Update settings
  updateFastCheck Boolean @default(true)
  update          Json // Array of regex patterns (stored as JSON)
  updateVerify    Json
  updateExclusions Json
  
  // Launch settings
  mainClass     String
  classPath     Json // Array of paths (stored as JSON)
  jvmArgs       Json // Array of JVM arguments (stored as JSON)
  clientArgs    Json // Array of client arguments (stored as JSON)
  
  // Metadata
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([enabled])
  @@index([sortIndex])
  @@index([enabled, sortIndex])
  @@map("client_profiles")
}

// Update cache model (for tracking file hashes)
model FileHash {
  id        String   @id @default(uuid())
  profileId String
  path      String
  hash      String
  size      BigInt
  updatedAt DateTime @updatedAt
  
  @@unique([profileId, path])
  @@index([profileId])
  @@map("file_hashes")
}

// Auth attempts tracking (for rate limiting)
model AuthAttempt {
  id        String   @id @default(uuid())
  username  String?
  ipAddress String
  success   Boolean
  timestamp DateTime @default(now())
  
  @@index([ipAddress, timestamp])
  @@index([username, timestamp])
  @@map("auth_attempts")
}

// IP Whitelist/Blacklist
model IpRule {
  id        String   @id @default(uuid())
  ip        String   @unique
  type      IpRuleType
  reason    String?
  createdAt DateTime @default(now())
  expiresAt DateTime?
  
  @@map("ip_rules")
}

enum IpRuleType {
  WHITELIST
  BLACKLIST
}

// Server status cache
model ServerStatus {
  id            String   @id @default(uuid())
  serverAddress String   @unique
  online        Boolean
  players       Int?
  maxPlayers    Int?
  version       String?
  motd          String?
  ping          Int?
  lastChecked   DateTime @default(now())
  
  @@map("server_status")
}

// Server statistics - статистика онлайн игроков по часам
model ServerStatistics {
  id            String   @id @default(uuid())
  serverAddress String   // Адрес сервера (address:port)
  timestamp     DateTime  @default(now()) // Время записи
  hour          Int       // Час (0-23)
  online        Int       // Текущий онлайн
  average       Int       // Средний онлайн за час
  minimum       Int       // Минимальный онлайн за час
  maximum       Int       // Максимальный онлайн за час
  
  @@index([serverAddress, timestamp])
  @@index([serverAddress, hour])
  @@map("server_statistics")
}

// Client Version - хранит информацию о версиях клиентов на сервере
model ClientVersion {
  id            String   @id @default(uuid())
  version       String   @unique // Версия клиента (например, "1.20.4", "custom-1.0")
  title         String   // Название версии
  description   String?  // Описание версии
  
  // Файлы клиента
  clientJarPath String   // Путь к client.jar на сервере
  clientJarHash String   // SHA-256 хеш для проверки целостности
  clientJarSize BigInt   // Размер файла в байтах
  
  // Библиотеки
  librariesPath String?  // Путь к папке с библиотеками
  librariesHash  String?  // Хеш всех библиотек
  
  // Assets
  assetsPath    String?  // Путь к папке с assets
  assetsHash    String?  // Хеш всех assets
  
  // Настройки запуска
  mainClass     String
  jvmVersion    String   @default("17")
  jvmArgs       Json     // Массив JVM аргументов
  clientArgs    Json     // Массив аргументов клиента
  
  // Метаданные
  enabled       Boolean  @default(true)
  isDefault     Boolean  @default(false) // Версия по умолчанию
  downloadUrl   String?  // Базовый URL для загрузки (если используется CDN)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  files         ClientFile[]
  
  @@map("client_versions")
}

// Client File - информация о каждом файле клиента
model ClientFile {
  id            String   @id @default(uuid())
  versionId     String   // ID версии клиента
  clientDirectory String @default("") // Директория клиента (например, "hitech", "sandbox"); пустая строка для общих файлов версии
  filePath      String   // Относительный путь к файлу
  fileHash      String   // SHA-256 хеш
  fileSize      BigInt   // Размер в байтах
  fileType      String   // Тип: "jar", "library", "asset", "native", "other"
  downloadUrl   String?  // Прямой URL для загрузки (если используется CDN)
  verified      Boolean  @default(false) // Файл проверен на целостность
  lastVerified  DateTime? // Время последней проверки целостности
  integrityCheckFailed Boolean @default(false) // Флаг нарушения целостности
  
  version       ClientVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  
  // Уникальность файла теперь учитывает директорию клиента:
  // один и тот же относительный путь может существовать в разных clientDirectory
  @@unique([versionId, clientDirectory, filePath])
  @@index([versionId])
  @@index([fileType])
  @@index([clientDirectory])
  @@index([verified])
  @@index([integrityCheckFailed])
  @@map("client_files")
}

// Game Crash - логирование крэшей игры
model GameCrash {
  id            String   @id @default(uuid())
  userId        String?  // ID пользователя (если авторизован)
  username      String?  // Имя пользователя (для анонимных крэшей)
  profileId     String?  // ID профиля клиента
  profileVersion String? // Версия профиля
  serverAddress String?  // Адрес сервера
  serverPort    Int?     // Порт сервера
  
  // Информация о крэше
  exitCode      Int      // Код выхода процесса
  errorMessage  String?  @db.Text // Сообщение об ошибке
  stackTrace    String?  @db.Text // Stack trace (если есть)
  stderrOutput  String?  @db.Text // Вывод stderr
  stdoutOutput  String?  @db.Text // Последние строки stdout
  
  // Системная информация
  javaVersion   String?  // Версия Java
  javaPath      String?  // Путь к Java
  os            String?  // Операционная система
  osVersion     String?  // Версия ОС
  
  // Метаданные
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([profileId])
  @@index([serverAddress])
  @@index([createdAt])
  @@map("game_crashes")
}

// Server Connection Issue - проблемы с подключением к серверу
model ServerConnectionIssue {
  id            String   @id @default(uuid())
  userId        String?  // ID пользователя (если авторизован)
  username      String?  // Имя пользователя
  profileId     String?  // ID профиля клиента
  profileVersion String? // Версия профиля
  serverAddress String   // Адрес сервера
  serverPort    Int      // Порт сервера
  
  // Информация о проблеме
  issueType     ConnectionIssueType // Тип проблемы
  errorMessage  String?  @db.Text // Сообщение об ошибке
  logOutput     String?  @db.Text // Логи игры (релевантные строки)
  
  // Системная информация
  javaVersion   String?  // Версия Java
  os            String?  // Операционная система
  
  // Метаданные
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([profileId])
  @@index([serverAddress, serverPort])
  @@index([issueType])
  @@index([createdAt])
  @@map("server_connection_issues")
}

enum ConnectionIssueType {
  CONNECTION_REFUSED      // Соединение отклонено
  CONNECTION_TIMEOUT      // Таймаут соединения
  AUTHENTICATION_FAILED   // Ошибка аутентификации
  SERVER_FULL             // Сервер переполнен
  VERSION_MISMATCH        // Несовпадение версий
  NETWORK_ERROR           // Сетевая ошибка
  UNKNOWN                 // Неизвестная ошибка
}

// Launcher Error - ошибки лаунчера при запуске и работе
model LauncherError {
  id            String   @id @default(uuid())
  userId        String?  // ID пользователя (если авторизован)
  username      String?  // Имя пользователя
  
  // Информация об ошибке
  errorType     LauncherErrorType // Тип ошибки
  errorMessage  String   @db.Text // Сообщение об ошибке
  stackTrace    String?  @db.Text // Stack trace (если есть)
  component     String?  // Компонент, где произошла ошибка (например, "ProfileLoader", "FileDownloader")
  
  // Контекст ошибки
  action        String?  // Действие, которое выполнялось (например, "loadProfile", "downloadClient")
  url           String?  // URL, если ошибка связана с HTTP запросом
  statusCode    Int?     // HTTP статус код, если применимо
  
  // Системная информация
  userAgent     String?  // User agent браузера/Electron
  os            String?  // Операционная система
  osVersion     String?  // Версия ОС
  launcherVersion String? // Версия лаунчера
  
  // Метаданные
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([errorType])
  @@index([component])
  @@index([createdAt])
  @@map("launcher_errors")
}

enum LauncherErrorType {
  PROFILE_LOAD_ERROR      // Ошибка загрузки профиля
  FILE_DOWNLOAD_ERROR     // Ошибка загрузки файла
  API_ERROR               // Ошибка API запроса
  AUTHENTICATION_ERROR    // Ошибка аутентификации
  VALIDATION_ERROR        // Ошибка валидации данных
  FILE_SYSTEM_ERROR       // Ошибка файловой системы
  NETWORK_ERROR           // Сетевая ошибка
  ELECTRON_ERROR          // Ошибка Electron
  JAVA_DETECTION_ERROR    // Ошибка определения Java
  CLIENT_LAUNCH_ERROR     // Ошибка запуска клиента
  UNKNOWN_ERROR           // Неизвестная ошибка
  INFO_MESSAGE            // Информационное сообщение (для логирования)
}

// Game Launch - запись о каждом запуске игры
model GameLaunch {
  id            String   @id @default(uuid())
  userId        String?  // ID пользователя (если авторизован)
  username      String?  // Имя пользователя
  profileId     String?  // ID профиля клиента
  profileVersion String? // Версия профиля
  serverAddress String?  // Адрес сервера
  serverPort    Int?     // Порт сервера
  
  // Информация о запуске
  javaVersion   String?  // Версия Java
  javaPath      String?  // Путь к Java
  ram           Int?     // Выделенная RAM (MB)
  resolution    String?  // Разрешение экрана (widthxheight)
  fullScreen    Boolean  @default(false)
  autoEnter     Boolean  @default(false)
  
  // Системная информация
  os            String?  // Операционная система
  osVersion     String?  // Версия ОС
  
  // Метаданные
  createdAt     DateTime @default(now())
  
  // Relations
  session       GameSession?

  @@index([userId])
  @@index([profileId])
  @@index([serverAddress])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@map("game_launches")
}

// Game Session - сессия игры (от запуска до закрытия)
model GameSession {
  id            String   @id @default(uuid())
  launchId      String   @unique // ID запуска игры
  userId        String?  // ID пользователя
  username      String?  // Имя пользователя
  profileId     String?  // ID профиля клиента
  profileVersion String? // Версия профиля
  serverAddress String?  // Адрес сервера
  serverPort    Int?     // Порт сервера
  
  // Время сессии
  startedAt     DateTime @default(now()) // Время запуска
  endedAt       DateTime? // Время закрытия (null если игра еще запущена)
  duration      Int?     // Длительность в секундах (вычисляется при закрытии)
  
  // Статус
  exitCode      Int?     // Код выхода (0 = успешно, другие = ошибка)
  crashed       Boolean  @default(false) // Была ли игра закрыта из-за крэша
  
  // Метаданные
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  launch        GameLaunch @relation(fields: [launchId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([profileId])
  @@index([serverAddress])
  @@index([startedAt])
  @@index([endedAt])
  @@map("game_sessions")
}

// Notification - система уведомлений
model Notification {
  id            String   @id @default(uuid())
  userId        String   // ID пользователя
  type          NotificationType // Тип уведомления
  title         String   // Заголовок уведомления
  message       String   @db.Text // Текст уведомления
  data          Json?    // Дополнительные данные (JSON)
  
  // Статус
  read          Boolean  @default(false) // Прочитано ли уведомление
  readAt        DateTime? // Время прочтения
  
  // Метаданные
  createdAt     DateTime @default(now())
  
  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([type])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  CLIENT_UPDATE_AVAILABLE    // Доступно обновление клиента
  SERVER_STATUS_CHANGE      // Изменение статуса сервера
  LAUNCHER_UPDATE_AVAILABLE  // Доступно обновление лаунчера
  GAME_CRASH                 // Крэш игры
  CONNECTION_ISSUE           // Проблема подключения
  LAUNCHER_ERROR             // Ошибка лаунчера
  SYSTEM_MESSAGE             // Системное сообщение
  ADMIN_ALERT                // Административное предупреждение
}

// Launcher Version - версии лаунчера для обновлений
model LauncherVersion {
  id            String   @id @default(uuid())
  version       String   @unique // Версия лаунчера (например, "1.0.132")
  downloadUrl   String?  // URL для скачивания обновления
  fileHash      String?  // SHA-256 хеш файла для проверки целостности
  fileSize      BigInt?  // Размер файла в байтах
  releaseNotes  String?  @db.Text // Заметки о релизе
  isRequired    Boolean  @default(false) // Обязательное обновление
  enabled       Boolean  @default(true) // Включена ли версия
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([version])
  @@index([enabled])
  @@index([createdAt])
  @@map("launcher_versions")
}

// Audit Log - журнал аудита чувствительных операций
model AuditLog {
  id            String   @id @default(uuid())
  userId        String?  // ID пользователя (если авторизован)
  username      String?  // Имя пользователя
  action        String   // Действие (POST /api/users, DELETE /api/profiles/123, etc.)
  method        String   // HTTP метод
  path          String   // Путь запроса
  statusCode    Int      // HTTP статус код
  ipAddress     String?  // IP адрес
  userAgent     String?  // User agent
  requestId     String?  // ID запроса для трассировки
  success       Boolean  // Успешность операции
  errorMessage  String?  @db.Text // Сообщение об ошибке (если была)
  metadata      Json?    // Дополнительные данные (JSON)
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([requestId])
  @@map("audit_logs")
}