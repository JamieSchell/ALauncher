#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–≥—Ä–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

set -e

echo "üéÆ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–≥—Ä–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤..."
echo "======================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ backend
if ! pgrep -f "tsx watch src/index.ts" > /dev/null; then
    echo "‚ùå Backend –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ 'npm run dev:backend' —Å–Ω–∞—á–∞–ª–∞"
    exit 1
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BACKEND_DIR="/opt/ALauncher/packages/backend"
UPDATES_DIR="/opt/ALauncher/packages/backend/updates"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±—ç–∫–µ–Ω–¥–∞
cd "$BACKEND_DIR"

echo ""
echo "üì¶ –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ —É–∂–µ –ø—Ä–æ—Ñ–∏–ª–∏
if npm run list-profiles | grep -q "Found 0 profile(s)"; then
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π..."

    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å Vanilla 1.12.2
    echo "  ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ Vanilla 1.12.2..."
    npm run create-profile-1.12.2 > /dev/null 2>&1

    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å Forge 1.12.2
    echo "  ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ Forge 1.12.2..."
    npm run create-profile-1.12.2-forge > /dev/null 2>&1

    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å 1.21 –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    # npm run create-profile-1.21 > /dev/null 2>&1
else
    echo "‚úÖ –ü—Ä–æ—Ñ–∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç"
fi

echo ""
echo "üìÅ –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª–µ–π
echo "  ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤..."
mkdir -p "$UPDATES_DIR"/{minecraft-1.12.2,minecraft-1.12.2-forge}
mkdir -p "$UPDATES_DIR"/minecraft-1.12.2/{libraries,mods}
mkdir -p "$UPDATES_DIR"/minecraft-1.12.2-forge/{libraries,mods}

echo ""
echo "üìã –®–∞–≥ 3: –ü–æ–∫–∞–∑ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π..."

npm run list-profiles

echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:"
echo "   $UPDATES_DIR"
echo "   ‚îú‚îÄ‚îÄ assets/          # –ê—Å—Å–µ—Ç—ã Minecraft"
echo "   ‚îú‚îÄ‚îÄ minecraft-1.12.2/"
echo "   ‚îÇ   ‚îú‚îÄ‚îÄ client.jar   # <-- –°–Æ–î–ê –ù–£–ñ–ù–û –ü–û–ú–ï–°–¢–ò–¢–¨ –ö–õ–ò–ï–ù–¢"
echo "   ‚îÇ   ‚îú‚îÄ‚îÄ libraries/   # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏"
echo "   ‚îÇ   ‚îî‚îÄ‚îÄ mods/        # –ú–æ–¥—ã"
echo "   ‚îî‚îÄ‚îÄ minecraft-1.12.2-forge/"
echo "       ‚îú‚îÄ‚îÄ client.jar   # <-- –°–Æ–î–ê –ù–£–ñ–ù–û –ü–û–ú–ï–°–¢–ò–¢–¨ FORGE –ö–õ–ò–ï–ù–¢"
echo "       ‚îú‚îÄ‚îÄ libraries/   # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–≤–∫–ª—é—á–∞—è Forge)"
echo "       ‚îî‚îÄ‚îÄ mods/        # –ú–æ–¥—ã"
echo ""
echo "üîÑ –î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏:"
echo "   1. –°–∫–∞—á–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ñ–∞–π–ª—ã Minecraft"
echo "   2. –ü–æ–º–µ—Å—Ç–∏—Ç–µ client.jar –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
echo "   3. –î–ª—è Forge: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Forge –≤ –ø–∞–ø–∫—É libraries"
echo "   4. –î–æ–±–∞–≤—å—Ç–µ –º–æ–¥—ã –≤ –ø–∞–ø–∫—É mods/ –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ"
echo ""
echo "üí° –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo "   ‚Ä¢ npm run list-profiles          # –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏"
echo "   ‚Ä¢ npm run cli                   # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π CLI"
echo "   ‚Ä¢ npm run cli profile list      # –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –≤ CLI"
echo "   ‚Ä¢ npm run cli profile sync <id> # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã"